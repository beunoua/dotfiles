#!/bin/bash

# Usage function.
usage() {
    echo "Usage: add-to-ssh-agent [OPTION]..."
    echo "Add the SSH keys to the running ssh-agent."
    echo ""
    echo "Options:"
    echo "  -h, --help    Display this help and exit."
    echo "  -s, --start   Start the ssh-agent if not running."
    echo "  -k, --kill    Kill the ssh-agent."
    echo ""
}


# Starts the ssh-agent if not running.
start_ssh_agent() {
    if [ -z "$SSH_AGENT_PID" ]; then
        eval "$(ssh-agent -s)"
    fi
}

# Kills the ssh-agent.
kill_ssh_agent() {
    if [ -n "$SSH_AGENT_PID" ]; then
        ssh-agent -k
    fi
}



# -------------------------------------------------------------------------
# Starts the ssh-agent if not running and exits.
if [ "$1" == "-s" ] || [ "$1" == "--start" ]; then
    start_ssh_agent
    exit 0
fi

# -------------------------------------------------------------------------
# Kill the ssh-agent and exits.
if [ "$1" == "-k" ] || [ "$1" == "--kill" ]; then
    kill_ssh_agent
    exit 0
fi


# -------------------------------------------------------------------------
# Displays help.
if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    usage
    exit 0
fi

# -------------------------------------------------------------------------
# Add the SSH key to the running ssh-agent.

# Start the ssh-agent if not running.
start_ssh_agent

# Get the ssh key by reading the buffer.
PRIVATE_KEY=$(pbpaste)

# Add the key to the ssh-agent.
echo "$PRIVATE_KEY" | ssh-add - > /dev/null
